<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Review Invoice</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap"
	rel="stylesheet">
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
<link rel="stylesheet" th:href="@{/css/fragmentstyles.css}">
<link rel="stylesheet" th:href="@{/css/createstyles.css}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/path/to/formValidation.js"></script>
<style>
/* Additional styles to make card look consistent with existing design */
.card {
	margin-top: 100px;
	width: 100%;
	max-width: 1000px;
	margin: 100px auto 20px;
	background-color: #fff;
	box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
	border-radius: 8px;
	width: 100%;
}

.card-header {
	background: linear-gradient(to bottom, rgb(5, 5, 40), rgb(15, 32, 95));
	color: white;
	padding: 10px 15px;
	border-top-left-radius: 8px;
	border-top-right-radius: 8px;
}

.card-header h5 {
	margin: 0;
	text-align: center;
}

.card-body {
	padding: 15px;
}

.card-body p {
	margin: 10px 0;
	display: flow-root;
	justify-content: space-between;
}

.card-body strong {
	width: 150px;
	text-align: right;
	margin-right: 10px;
}

form {
	width: 100%; /* Set the form width to match the cards */
	max-width: 1000px; /* Ensure it doesn't exceed the container width */
	margin: 20px auto; /* Center it horizontally */
	padding: 15px; /* Add padding for better spacing */
	background-color: #fff; /* Match the card background */
	box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
	/* Add a card-like shadow */
	border-radius: 8px; /* Match the card's border radius */
}

.card-wrapper {
	display: flex;
	justify-content: space-between;
	gap: 20px; /* Add spacing between cards */
	margin-bottom: 30px; /* Create space below cards */
	margin-top: -75px;
}

.card {
	flex: 1;
}

.card-body {
	padding: 15px 20px;
}

/* Add spacing for the "Treatment Details" section */
.card.mb-4 {
	margin-top: 20px;
	/* Add top margin to separate from previous section */
}

.card h5 {
	text-align: center; /* Center card headers for consistency */
}

.row {
	display: flex;
	flex-wrap: wrap; /* Ensures proper alignment on smaller screens */
}

.col-md-6 {
	flex: 1; /* Ensure both columns take up equal space */
	padding: 0 10px; /* Optional padding for visual clarity */
}

body {
	background-color: rgb(220, 223, 239);
	font-family: 'Helvetica', sans-serif;
	font-size: 16px;
	color: #333;
	margin: 0;
	padding: 0;
	line-height: 1.6;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center; /* Center the form vertically */
	height: 100vh; /* Ensure the body takes the full viewport height */
	min-height: 100vh; /* Makes the body full height of the viewport */
}

form {
	margin-top: 10px;
	max-width: 1000px;
}

.centered-text {
	text-align: center;
}

.container {
	background-color: white;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	width: 70%;
	margin-top: 750px;
	padding: 20px;
	border-radius: 8px;
}

.error-message {
	color: #d93025;
	font-size: 14px;
	margin-top: 5px;
	display: block;
}

.success-message {
	text-align: center;
	color: #0f9d58;
	font-size: 16px;
	margin: 20px 0;
	display: block;
}
</style>
</head>
<body>
	<!-- Include Header Fragment -->
	<div th:replace="~{fragments/header-loggedin :: header}"></div>


	<div class="container">

		<h4 class="centered-text">Review Invoice</h4>

		<div th:if="${errorMessage}" class="error-message">
			<p th:text="${errorMessage}"></p>
		</div>
		<div th:if="${message}" class="success-message">
			<p th:text="${message}"></p>
		</div>

		<div class="card-wrapper">
			<!-- Patient Information Card -->
			<div class="card mb-3">
				<div class="card-header">
					<h5>Patient Information</h5>
				</div>
				<div class="card-body">
					<p>
						<strong>Patient:</strong> <span
							th:text="${treatment.appointment != null && treatment.appointment.patient != null ? treatment.appointment.patient.patientName : 'N/A'}"></span>
					</p>
					<p>
						<strong>Patient ID:</strong> <span
							th:text="${treatment.appointment != null && treatment.appointment.patient != null ? treatment.appointment.patient.patientID : 'N/A'}"></span>
					</p>
					<p>
						<strong>Contact:</strong> <span
							th:text="${treatment.appointment != null && treatment.appointment.patient != null ? treatment.appointment.patient.contactNumber : 'N/A'}"></span>
					</p>
					<p>
						<strong>Email:</strong> <span
							th:text="${treatment.appointment != null && treatment.appointment.patient != null && treatment.appointment.patient.user != null ? treatment.appointment.patient.user.emailID : 'N/A'}"></span>
					</p>
				</div>
			</div>
			<!-- Doctor Information Card -->
			<div class="card mb-3">
				<div class="card-header">
					<h5>Doctor Information</h5>
				</div>
				<div class="card-body">
					<p>
						<strong>Doctor:</strong> <span
							th:text="${treatment.appointment != null && treatment.appointment.doctor != null ? treatment.appointment.doctor.doctorName : 'N/A'}"></span>
					</p>
					<p>
						<strong>Specialization:</strong> <span
							th:text="${treatment.appointment != null && treatment.appointment.doctor != null ? treatment.appointment.doctor.specialization : 'N/A'}"></span>
					</p>
				</div>
			</div>
		</div>

		<div class="card mb-4">
			<div class="card-header">
				<h5>Treatment Details</h5>
			</div>
			<div class="card-body">
				<p>
					<strong>Treatment ID:</strong> <span
						th:text="${treatment.treatmentID}"></span>
				</p>
				<p>
					<strong>Date:</strong> <span
						th:text="${treatment.appointment != null && treatment.appointment.appointmentDate != null ? #temporals.format(treatment.appointment.appointmentDate, 'dd-MM-yyyy HH:mm') : 'N/A'}"></span>
				</p>
				<p>
					<strong>Diagnosis:</strong> <span
						th:text="${treatment.diagnosis != null ? treatment.diagnosis : 'N/A'}"></span>
				</p>
				<p>
					<strong>Treatment Details:</strong> <span
						th:text="${treatment.treatmentDetails != null ? treatment.treatmentDetails : 'N/A'}"></span>
				</p>
			</div>
		</div>

		<div class="card mb-4">
			<div class="card-header">
				<h5>Prescription Details</h5>
			</div>
			<div class="card-body">
				<!-- Show prescription details if they exist and are a collection -->
				<div
					th:if="${prescription != null && prescription.prescriptionDetails != null && T(java.util.Collection).isAssignableFrom(prescription.prescriptionDetails.getClass())}">
					<table class="table table-striped">
						<thead>
							<tr>
								<th>Medication</th>
								<th>Dosage</th>
								<th>Frequency</th>
								<th>Duration</th>
								<th>Instructions</th>
								<th class="text-end">Cost</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="med, rowStat : ${prescription.prescriptionDetails}"
								th:id="'med-row-' + ${rowStat.index}">
								<td th:text="${med.medicine.medicineName}"
									th:data-cost="${med.medicine.cost}"></td>
								<td th:text="${med.dosage}"></td>
								<td th:text="${med.frequency}" class="frequency-data"></td>
								<td th:text="${med.duration}" class="duration-data"></td>
								<td th:text="${med.instructions}"></td>
								<td class="text-end med-cost"
									th:text="${'Rs.' + #numbers.formatDecimal(med.medicine.cost, 1, 2)}"></td>
							</tr>
						</tbody>
						<tfoot>
							<tr>
								<td colspan="5" class="text-end"><strong>Total
										Prescription Cost:</strong></td>
								<td class="text-end"><strong id="totalCost"
									th:text="${'Rs.' + #numbers.formatDecimal(prescriptionTotalCost != null ? prescriptionTotalCost : 0, 1, 2)}"></strong></td>
							</tr>
						</tfoot>
					</table>
				</div>

				<!-- Show simple prescription details if not a collection -->
				<div
					th:if="${prescription != null && prescription.prescriptionDetails != null && !T(java.util.Collection).isAssignableFrom(prescription.prescriptionDetails.getClass())}">
					<p>
						<strong>Prescription Details:</strong> <span
							th:text="${prescription.prescriptionDetails}"></span>
					</p>
					<p>
						<strong>Dosage:</strong> <span
							th:text="${prescription.dosage != null ? prescription.dosage : 'N/A'}"></span>
					</p>
					<p>
						<strong>Duration:</strong> <span
							th:text="${prescription.duration != null ? prescription.duration : 'N/A'}"></span>
					</p>
				</div>

				<!-- Show message if no prescription details -->
				<div
					th:if="${prescription == null || prescription.prescriptionDetails == null}">
					<p class="text-center">No prescription details available</p>
				</div>
			</div>
		</div>

		<form th:action="@{/invoices/generate-invoice}" method="post"
			id="invoiceForm">
			<input type="hidden" name="treatmentID"
				th:value="${treatment.treatmentID}" /> <input type="hidden"
				name="prescriptionID"
				th:value="${prescription != null ? prescription.prescriptionID : ''}" />

			<input type="hidden" name="source" th:value="${source}" />

			<div class="card mb-4">
				<div class="card-header">
					<h5>Invoice Details</h5>
				</div>
				<div class="card-body">
					<div class="row mb-3">
						<div class="col-md-6">
							<label for="treatmentCost" class="form-label">Treatment
								Cost</label>
							<div class="input-group">
								<span class="input-group-text">₹</span> <input type="number"
									step="0.01" min="0" class="form-control" id="treatmentCost"
									name="treatmentCost" required>
							</div>
						</div>
						<div class="col-md-6">
							<label class="form-label">Prescription Cost
								(Auto-calculated)</label>
							<div class="input-group">
								<span class="input-group-text">₹</span> <input type="number"
									step="0.01" class="form-control" id="prescriptionCost"
									name="prescriptionCost"
									th:value="${prescriptionTotalCost != null ? prescriptionTotalCost : 0}"
									readonly>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-md-6">
							<label for="invoiceStatus" class="form-label">Invoice
								Status</label> <select class="form-select" id="invoiceStatus"
								name="invoiceStatus" required>
								<option
									th:each="status : ${T(com.healthcaremngnt.enums.InvoiceStatus).values()}"
									th:value="${status}" th:text="${status}"
									th:if="${status == T(com.healthcaremngnt.enums.InvoiceStatus).DRAFT}"
									selected></option>
								<option
									th:each="status : ${T(com.healthcaremngnt.enums.InvoiceStatus).values()}"
									th:value="${status}" th:text="${status}"
									th:unless="${status == T(com.healthcaremngnt.enums.InvoiceStatus).DRAFT}">
								</option>
							</select>
						</div>
						<div class="col-md-6">
							<label class="form-label">Total Amount</label>
							<div class="input-group">
								<span class="input-group-text">₹</span> <input type="number"
									step="0.01" class="form-control" id="totalAmount"
									name="totalAmount" readonly>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="d-flex justify-content-between">
				<button type="submit" class="btn btn-primary">Generate
					Invoice</button>

			</div>
		</form>
	</div>

	<!-- Include Footer Fragment -->
	<div th:replace="~{fragments/footer :: footer}"></div>

	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
	<script>
		
		document.addEventListener('DOMContentLoaded', function() {
		    // Calculate the correct cost for each medication row
		    const rows = document.querySelectorAll('tbody tr');
		    let totalCost = 0;
		    
		    rows.forEach(row => {
		      // Get the necessary values from the row
		      const medicineCell = row.querySelector('td:first-child');
		      const frequencyCell = row.querySelector('.frequency-data');
		      const durationCell = row.querySelector('.duration-data');
		      const costCell = row.querySelector('.med-cost');
		      
		      // Get the cost per unit
		      const costPerUnit = parseFloat(medicineCell.getAttribute('data-cost')) || 0;
		      
		      // Parse the frequency (e.g., "1-0-1") and calculate doses per day
		      const frequencyText = frequencyCell.textContent;
		      const dosesPerDay = frequencyText.split('-').reduce((total, num) => total + (parseInt(num, 10) || 0), 0);
		      
		      // Get the duration in days
		      const durationInDays = parseInt(durationCell.textContent, 10) || 0;
		      
		      // Calculate the correct cost
		      const calculatedCost = (dosesPerDay * durationInDays * costPerUnit).toFixed(2);
		      
		      // Update the cost cell
		      if (calculatedCost > 0) {
		        costCell.textContent = `Rs.${calculatedCost}`;
		        totalCost += parseFloat(calculatedCost);
		      }
		    });
		    
		    // Update the total cost in the table footer
		    document.getElementById('totalCost').textContent = `Rs.${totalCost.toFixed(2)}`;
		    
		    // Also update the prescription cost input field
		    document.getElementById('prescriptionCost').value = totalCost.toFixed(2);
		    
		    // Recalculate the total invoice amount
		    calculateTotal();
		  });
		
		// Calculate total amount when treatment cost changes
		document.getElementById('treatmentCost').addEventListener('input', calculateTotal);

		// Set initial value for treatment cost
		document.getElementById('treatmentCost').value = 0;

		function calculateTotal() {
		    const treatmentCost = parseFloat(document.getElementById('treatmentCost').value) || 0;
		    const prescriptionCost = parseFloat(document.getElementById('prescriptionCost').value) || 0;
		    const totalAmount = treatmentCost + prescriptionCost;
		    document.getElementById('totalAmount').value = totalAmount.toFixed(2);
		}
	</script>
</body>
</html>