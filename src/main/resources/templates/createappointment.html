<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Book Doctor Appointment</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap"
	rel="stylesheet">
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
	rel="stylesheet">
<link rel="stylesheet" th:href="@{/css/fragmentstyles.css}">
<link rel="stylesheet" th:href="@{/css/createstyles.css}">
<style>
body {
	background-color: rgb(220, 223, 239);
	font-family: 'Helvetica', sans-serif;
	font-size: 16px;
	color: #333;
	margin: 0;
	padding: 0;
	line-height: 1.6;
}

form {
	margin-top: 30px;
}

.main-content {
	display: flex;
	justify-content: center;
	padding: 20px;
	margin-top: 20px;
	margin-bottom: 20px;
}

.form-container {
	background-color: white;
	border-radius: 8px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	width: 100%;
	max-width: 600px;
	padding: 30px;
	margin-top: 520px;
}

.form-title {
	text-align: center;
	margin-bottom: 25px;
	color: #333;
	font-weight: 600;
}

.form-row {
	display: flex;
	align-items: center;
	margin-bottom: 20px;
}

.form-label {
	width: 40%;
	text-align: right;
	padding-right: 15px;
	font-weight: 500;
	color: #555;
}

.form-input {
	width: 60%;
}

.form-control {
	width: 100%;
	padding: 10px;
	border: 1px solid #ddd;
	border-radius: 4px;
	font-size: 16px;
	transition: border-color 0.3s;
}

.form-control:focus {
	outline: none;
	border-color: #4285f4;
	box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
}

textarea.form-control {
	min-height: 100px;
	resize: vertical;
}

.info-text {
	font-weight: 500;
	color: #333;
	padding: 10px;
	background-color: #f8f9fa;
	border-radius: 4px;
	border-left: 4px solid #4285f4;
}

.btn-container {
	display: flex;
	justify-content: center;
	margin-top: 30px;
}

.btn-submit {
	background-color: #4285f4;
	color: white;
	border: none;
	border-radius: 4px;
	padding: 12px 30px;
	font-size: 16px;
	cursor: pointer;
	transition: background-color 0.3s;
	font-weight: 500;
}

.btn-submit:hover {
	background-color: #3367d6;
}

.error-message {
	color: #d93025;
	font-size: 14px;
	margin-top: 5px;
	display: block;
}

.success-message {
	text-align: center;
	color: #0f9d58;
	font-size: 16px;
	margin: 20px 0;
	display: block;
	padding: 10px;
	background-color: #e8f5e9;
	border-radius: 4px;
}

/* Message box styles */
.message-box {
	margin-bottom: 20px;
	padding: 10px 15px;
	border-radius: 4px;
	text-align: center;
}

/* Responsive adjustments */
@media ( max-width : 768px) {
	.form-row {
		flex-direction: column;
		align-items: flex-start;
	}
	.form-label, .form-input {
		width: 100%;
		text-align: left;
	}
	.form-label {
		margin-bottom: 8px;
	}
}
</style>
</head>
<body>
	<!-- Include Header Fragment -->
	<div th:replace="~{fragments/header-loggedin :: header}"></div>

	<div class="main-content">
		<div class="form-container">
			<h3 class="form-title">Book Doctor Appointment</h3>

			<!-- Display error or success message if available -->
			<div th:if="${errorMessage}" class="message-box error-message">
				<p th:text="${errorMessage}"></p>
			</div>
			<div th:if="${message}" class="message-box success-message">
				<p th:text="${message}"></p>
			</div>

			<form th:action="@{/appointments/bookAppointment}" method="POST"
				id="appointmentForm">
				<!-- Hidden fields for URL parameters -->
				<input type="hidden" th:value="${source}" name="source"> <input
					type="hidden" th:value="${isFollowup}" name="isFollowup"> <input
					type="hidden" th:value="${treatmentID}" name="treatmentID"
					th:if="${treatmentID != null}"> <input
					type="hidden" th:value="${parentAppointmentID}" name="parentAppointmentID"
					th:if="${parentAppointmentID != null}">

				<!-- Patient Information -->
				<div class="form-row">
					<div class="form-label required">Patient:</div>
					<div class="form-input">
						<th:block th:if="${patient != null}">
							<div class="info-text" th:text="${patient.patientName}"></div>
							<input type="hidden" id="patientID" name="patientID"
								th:value="${patient.patientID}" />
						</th:block>
						<th:block th:unless="${patient != null}">
							<select class="form-control" id="patientID" name="patientID"
								required aria-required="true">
								<option value="" disabled selected>Select Patient</option>
								<th:block th:each="pat : ${patients}">
									<option th:value="${pat.patientID}"
										th:text="${pat.patientName}"></option>
								</th:block>
							</select>
							<span class="error-message" id="patientIDError"></span>
						</th:block>
					</div>
				</div>

				<!-- Doctor Information -->
				<div class="form-row">
					<div class="form-label required">Doctor:</div>
					<div class="form-input">
						<th:block th:if="${doctor != null}">
							<div class="info-text" th:text="${doctor.doctorName}"></div>
							<input type="hidden" id="doctorID" name="doctorID"
								th:value="${doctor.doctorID}" />
						</th:block>
						<th:block th:unless="${doctor != null}">
							<select class="form-control" id="doctorID" name="doctorID"
								required aria-required="true">
								<option value="" disabled selected>Select Doctor</option>
								<th:block th:each="doc : ${doctors}">
									<option th:value="${doc.doctorID}" th:text="${doc.doctorName}"></option>
								</th:block>
							</select>
							<span class="error-message" id="doctorIDError"></span>
						</th:block>
					</div>
				</div>

				<!-- Available Date -->
				<div class="form-row">
					<div class="form-label required">Available Date:</div>
					<div class="form-input">
						<select class="form-control" id="date" name="date" required
							aria-required="true">
							<option value="" disabled selected>Select Date</option>
						</select> <span class="error-message" id="dateError"></span>
					</div>
				</div>

				<!-- Available Time Slots -->
				<div class="form-row">
					<div class="form-label required">Available Time Slots:</div>
					<div class="form-input">
						<select class="form-control" id="time" name="time" required
							aria-required="true">
							<option value="" disabled selected>Select Time Slot</option>
						</select> <span class="error-message" id="timeError"></span>
					</div>
				</div>

				<!-- Reason for Visit -->
				<div class="form-row">
					<div class="form-label">Reason for Visit:</div>
					<div class="form-input">
						<textarea class="form-control" id="reason" name="reason"
							placeholder="Please describe your symptoms or reason for visit"></textarea>
					</div>
				</div>

				<!-- Priority Selection -->
				<div class="form-row">
					<div class="form-label required">Priority:</div>
					<div class="form-input">
						<select class="form-control" id="priority" name="priority"
							required aria-required="true">
							<option
								th:each="priority : ${T(com.healthcaremngnt.enums.Priority).values()}"
								th:value="${priority}" th:text="${priority}"></option>
						</select> <span class="error-message" id="priorityError"></span>
					</div>
				</div>

				<!-- Appointment Status -->
				<!-- <div class="form-row">
					<div class="form-label">Appointment Status:</div>
					<div class="form-input">
						<select class="form-control" id="appointmentStatus"
							name="appointmentStatus">
							<option value="SCHEDULED" selected>SCHEDULED</option>
							<th:block
								th:each="status : ${T(com.healthcaremngnt.enums.AppointmentStatus).values()}">
								<option th:if="${status.name() == 'FOLLOWUP'}"
									th:value="${status}" th:text="${status}"></option>
							</th:block>
						</select>
					</div>
				</div> -->

				<!-- Submit Button -->
				<div class="btn-container">
					<button type="submit" class="btn-submit">Book Appointment</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Include Footer Fragment -->
	<div th:replace="~{fragments/footer :: footer}"></div>

	<script
		src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script>
		$(document)
				.ready(
						function() {
							// Form validation
							function validateForm() {
								let isValid = true;

								// Clear previous error messages
								$('.error-message').text('');

								// Only validate fields that are visible/enabled
								if ($('#doctorID').is(':visible')
										&& !$('#doctorID').val()) {
									$('#doctorIDError').text(
											'Please select a doctor');
									isValid = false;
								}

								if ($('#patientID').is(':visible')
										&& !$('#patientID').val()) {
									$('#patientIDError').text(
											'Please select a patient');
									isValid = false;
								}

								if (!$('#date').val()) {
									$('#dateError')
											.text('Please select a date');
									isValid = false;
								}

								if (!$('#time').val()) {
									$('#timeError').text(
											'Please select a time slot');
									isValid = false;
								}

								if (!$('#priority').val()) {
									$('#priorityError').text(
											'Please select a priority');
									isValid = false;
								}

								return isValid;
							}

							// Form submission handler
							$('#appointmentForm').on('submit', function(e) {
								if (!validateForm()) {
									e.preventDefault();
								}
							});

							// Get doctorID - either from visible select or hidden input
							function getDoctorID() {
								return $('#doctorID').is(':visible') ? $(
										'#doctorID').val() : $('#doctorID')
										.val();
							}

							// Load available dates immediately if doctor is pre-selected
							if ($('#doctorID').val()
									&& !$('#doctorID').is(':visible')) {
								loadAvailableDates(getDoctorID());
							}

							// Dynamically update available dates based on selected doctor
							$('#doctorID').change(function() {
								var doctorID = getDoctorID();
								if (doctorID) {
									loadAvailableDates(doctorID);
								}
							});

							// Function to load available dates
							function loadAvailableDates(doctorID) {
								$('#date')
										.empty()
										.append(
												'<option value="" disabled selected>Select Date</option>');
								$('#time')
										.empty()
										.append(
												'<option value="" disabled selected>Select Time Slot</option>');

								$
										.ajax({
											url : '/appointments/available-dates',
											method : 'GET',
											data : {
												doctorID : doctorID
											},
											success : function(response) {
												if (response
														&& response.length > 0) {
													$
															.each(
																	response,
																	function(
																			key,
																			value) {
																		$(
																				'#date')
																				.append(
																						$(
																								'<option></option>')
																								.attr(
																										'value',
																										value)
																								.text(
																										value));
																	});
												} else {
													$('#dateError')
															.text(
																	'No available dates for this doctor');
												}
											},
											error : function() {
												$('#dateError')
														.text(
																'Failed to load available dates');
											}
										});
							}

							// Dynamically update available time slots based on selected date
							$('#date')
									.change(
											function() {
												var doctorID = getDoctorID();
												var date = $('#date').val();
												$('#time')
														.empty()
														.append(
																'<option value="" disabled selected>Select Time Slot</option>');

												if (doctorID && date) {
													$
															.ajax({
																url : '/appointments/available-time-slots',
																method : 'GET',
																data : {
																	doctorID : doctorID,
																	date : date
																},
																success : function(
																		response) {
																	if (response
																			&& response.length > 0) {
																		$
																				.each(
																						response,
																						function(
																								key,
																								value) {
																							$(
																									'#time')
																									.append(
																											$(
																													'<option></option>')
																													.attr(
																															'value',
																															value)
																													.text(
																															value));
																						});
																	} else {
																		$(
																				'#timeError')
																				.text(
																						'No available time slots for this date');
																	}
																},
																error : function() {
																	$(
																			'#timeError')
																			.text(
																					'Failed to load available time slots');
																}
															});
												}
											});
						});
	</script>
</body>
</html>